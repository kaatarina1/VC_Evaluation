const translations = {
  en: {
    title: "Voice Evaluation Survey",
    aboutTitle: "About Me & Project",
    aboutText: "Hi, I am Katarina Gojković, a student at the Faculty of Computer Science and Informatics at the University of Ljubljana. I am researching the quality of different voice conversion models and software used for real-time voice conversion. By taking this survey, you will help me greatly in my research. Thank you for your time and participation!",
    intro: "You will be evaluating a set of audio recordings. The dataset includes 5 different sentences spoken by male and female speakers in both English and Slovenian (a total of 20 sentences). For each sentence, there are six converted versions of the original speaker's audio.",
    evaluationProcedure: "Evaluation Procedure",
    step1: "Listen to the reference audio (the original speaker) for the sentence.",
    step2: "Then listen to all six converted audio versions of the same sentence.",
    step3: "Rate each converted audio on the following criteria:",
    ratingCriteria: "Rating Criteria",
    dissimilarity: "Intonation: how closely the pitch contour of the converted voice follows that of the reference, reflecting how well the natural rise and fall of speech is preserved.",
    naturalness: "Naturalness: How natural the converted voice sounds.",
    pronunciation: "Pronunciation: How accurate the pronunciation of the converted voice is.",
    audioQuality: "Audio Quality: Overall quality of the audio.",
    ratingNote: "It is recommended to first listen to the reference audio and then all converted versions before rating any of them.",
    ratingScale: "Rating Scale",
    ratingScaleDesc: "Ratings are from 0 to 10:",
    rating0: "0 = Very similar to the reference / Very unnatural / Very inaccurate / Very poor quality",
    rating10: "10 = Very different from the reference / Very natural / Very accurate / Excellent quality",
    submitButton: "Submit Ratings",
    generatingWaiting: "⏳ Generating survey, please wait...",
    loaderWaiting: "⏳ Please wait, uploading your results...",
    loaderFinished: "✅ Thank you! Your ratings have been submitted.",
    langLabel: "Language:",
    langEnglish: "English",
    langSlovenian: "Slovenian",
    langSerbian: "Serbian"
  },
  sl: {
    title: "Anketiranje Ocene Glasu",
    aboutTitle: "O meni in projektu",
    aboutText: "Pozdravljeni! Sem Katarina Gojković, študentka Fakultete za računalništvo in informatiko na Univerzi v Ljubljani. Raziskujem kakovost različnih modelov in programov za pretvorbo glasu v realnem času. Z izpolnitvijo te ankete mi boste močno pomagali pri raziskavi. Hvala za vaš čas in sodelovanje!",
    intro: "Ocenjevali boste nabor zvočnih posnetkov. Nabor vključuje 5 različnih stavkov, ki jih govorijo moški in ženski govorci v angleščini in slovenščini (skupaj 20 stavkov). Za vsak stavek obstaja šest pretvorjenih različic izvirnega govorca.",
    evaluationProcedure: "Postopek ocenjevanja",
    step1: "Poslušajte referenčni posnetek (izvirni govorec) za stavek.",
    step2: "Nato poslušajte vseh šest pretvorjenih različic istega stavka.",
    step3: "Ocenite vsak pretvorjeni posnetek po naslednjih kriterijih:",
    ratingCriteria: "Kriteriji ocenjevanja",
    dissimilarity: "Intonation: Kako natančno se kontura višine tona pretvorjenega glasu ujema s referenčnim glasom, kar odraža, kako dobro je ohranjeno naravno naraščanje in padanje govora.",
    naturalness: "Naturalness: Kako naraven se pretvorjeni glas sliši.",
    pronunciation: "Pronunciation: Kako natančna je izgovorjava pretvorjenega glasu.",
    audioQuality: "Audio Quality: Splošna kakovost zvoka.",
    ratingNote: "Priporočljivo je najprej poslušati referenčni posnetek in nato vse pretvorjene različice, preden ocenite katerikoli posnetek.",
    ratingScale: "Skala ocenjevanja",
    ratingScaleDesc: "Ocene so od 0 do 10:",
    rating0: "0 = Zelo podoben referenci / Zelo nenaraven / Zelo netočen / Zelo slaba kakovost",
    rating10: "10 = Zelo drugačen od reference / Zelo naraven / Zelo natančen / Odlična kakovost",
    submitButton: "Pošlji ocene",
    generatingWaiting: "⏳ Generiram anketo, prosimo počakajte...",
    loaderWaiting: "⏳ Prosimo, počakajte, naložitev vaših rezultatov poteka...",
    loaderFinished: "✅ Hvala! Vaše ocene so bile poslane.",
    langLabel: "Jezik:",
    langEnglish: "Angleščina",
    langSlovenian: "Slovenščina",
    langSerbian: "Srbščina"
  },
  sr: {
    title: "Anketiranje Ocene Glasu",
    aboutTitle: "O meni i projektu",
    aboutText: "Pozdravljeni! Sem Katarina Gojković, studentkinja Fakulteta za računarstvo i informatiku na Univerzitetu u Ljubljani. Istražujem kvalitet različitih modela i programa za konverziju glasa u realnom vremenu. Popunjavanjem ove ankete značajno ćete mi pomoći u istraživanju. Hvala na vašem vremenu i učešću!",
    intro: "Ocenjivaćete set audio snimaka. Skup uključuje 5 različitih rečenica koje govore muški i ženski govornici na engleskom i slovenačkom (ukupno 20 rečenica). Za svaku rečenicu postoji šest konvertovanih verzija izvornih snimaka.",
    evaluationProcedure: "Postupak ocenjivanja",
    step1: "Slušajte referentni audio (izvorni govornik) za rečenicu.",
    step2: "Zatim poslušajte svih šest konvertovanih verzija iste rečenice.",
    step3: "Ocenite svaki konvertovani audio prema sledećim kriterijumima:",
    ratingCriteria: "Kriterijumi ocenjivanja",
    dissimilarity: "Intonation: Koliko se kontura visine tona konvertovanog glasa poklapa sa referentnim glasom, što odražava koliko je prirodan uspon i pad govora očuvan.",
    naturalness: "Naturalness: Koliko prirodno zvuči konvertovani glas.",
    pronunciation: "Pronunciation: Koliko je tačan izgovor konvertovanog glasa.",
    audioQuality: "Audio Quality: Ukupni kvalitet zvuka.",
    ratingNote: "Preporučuje se prvo poslušati referentni audio, a zatim sve konvertovane verzije pre ocenjivanja.",
    ratingScale: "Skala ocenjivanja",
    ratingScaleDesc: "Ocene su od 0 do 10:",
    rating0: "0 = Veoma slično referenci / Veoma neprirodno / Veoma netačno / Veoma loš kvalitet",
    rating10: "10 = Veoma različito od reference / Veoma prirodno / Veoma tačno / Odličan kvalitet",
    submitButton: "Pošalji ocene",
    generatingWaiting: "⏳ Anketa se generiše, molimo sačekajte...",
    loaderWaiting: "⏳ Molimo sačekajte, učitavanje vaših rezultata je u toku...",
    loaderFinished: "✅ Hvala! Vaše ocene su poslati.",
    langLabel: "Jezik:",
    langEnglish: "Engleski",
    langSlovenian: "Slovenački",
    langSerbian: "Srpski"
  }
};
function setLanguage(lang) {
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (translations[lang][key]) {
      el.innerText = translations[lang][key];
    }
  });
}

// Detect dropdown change
document.getElementById("langSelect").addEventListener("change", (e) => {
  setLanguage(e.target.value);
});

// Optional: default to English
setLanguage("en");

// Configuration
    const config = {
      genders: ['m', 'f'],
      languages: [
        { code: 'en', name: 'English' },
        { code: 'slo', name: 'Slovenian' }
      ],
      sentences: [1, 2, 3, 4, 5],
      models: ['beatrice1', 'beatrice2', 'joker', 'maggie', 'monster', 'onnx'],
      ratings: [
        { id: 'dissimilarity', label: 'Intonation' },
        { id: 'naturalness', label: 'Naturalness' },
        { id: 'pronunciation', label: 'Pronunciation' },
        { id: 'audioQuality', label: 'Audio Quality' },
      ]
    };

    function updateValue(slider, spanId) {
      document.getElementById(spanId).textContent = slider.value;
    }

    async function generateSurvey() {
      const overlay = document.getElementById("loaderOverlay");
      const surveyLoading = document.getElementById("surveyLoading");
      const waitingText = document.getElementById("waiting");
      const finishedText = document.getElementById("finished");

      // Show loader
      overlay.style.display = "flex";
      surveyLoading.style.display = "block";
      waitingText.style.display = "none";
      finishedText.style.display = "none";

      // Let the browser render the overlay before heavy DOM work
      await new Promise(r => setTimeout(r, 50));
      const container = document.getElementById('survey-container');
      let sectionIndex = 0;
      
      config.genders.forEach(gender => {
        config.languages.forEach(language => {
          config.sentences.forEach(sentence => {
            sectionIndex++;
            
            const genderName = gender === 'm' ? 'Male' : 'Female';
            const referenceAudio = `inputs/${gender}/input_${language.code}_${sentence}.wav`;
            
            // Create section
            const section = document.createElement('div');
            section.className = 'bg-white shadow rounded-xl p-6 mb-8 border border-pink-200';
            
            // Section header
            const header = document.createElement('h2');
            header.className = 'text-lg font-semibold mb-4 text-pink-800';
            header.textContent = `Sentence ${sentence} – ${genderName} – ${language.name}`;
            section.appendChild(header);
            
            // Reference audio
            const refDiv = document.createElement('div');
            refDiv.className = 'mb-6';
            refDiv.innerHTML = `
              <p class="mb-1 text-pink-700">Reference voice:</p>
              <audio preload="none" controls class="w-64">
                <source src="${referenceAudio}" type="audio/wav">
              </audio>
            `;
            section.appendChild(refDiv);
            
            // Desktop layout
            const desktopDiv = document.createElement('div');
            desktopDiv.className = 'hidden lg:block';
            
            const desktopGrid = document.createElement('div');
            desktopGrid.className = 'grid grid-cols-7 gap-4';
            
            // Labels column for desktop
            const labelsCol = document.createElement('div');
            labelsCol.className = 'col-span-1';
            labelsCol.innerHTML = `
              <div class="h-12 mb-4"></div>
              <div class="space-y-8">
                ${config.ratings.map(rating => `
                  <div class="flex items-center h-5">
                    <label class="text-sm font-medium text-pink-700">${rating.label}</label>
                  </div>
                `).join('')}
              </div>
            `;
            desktopGrid.appendChild(labelsCol);
            
            // Model columns for desktop
            config.models.forEach((model, modelIndex) => {
              const modelAudio = `data/${gender}/${model}/monitor_${language.code}_${sentence}.wav`;
              const modelCol = document.createElement('div');
              modelCol.className = 'col-span-1 flex flex-col items-center';
              
              const slidersHtml = config.ratings.map(rating => {
                const inputName = `${rating.id}_${model}_s${sectionIndex}`;
                const valueId = `${inputName}_value`;
                return `
                  <div class="flex items-center space-x-2">
                    <input type="range" min="0" max="10" value="5" step="1" name="${inputName}" 
                           class="flex-1 accent-pink-500" oninput="updateValue(this, '${valueId}')">
                    <span id="${valueId}" class="text-sm font-medium w-6 text-pink-700">5</span>
                  </div>
                `;
              }).join('');
              
              modelCol.innerHTML = `
                <audio preload="none" controls class="w-36 mb-4 audio_style">
                  <source src="${modelAudio}" type="audio/wav">
                </audio>
                <div class="space-y-8 w-full">
                  ${slidersHtml}
                </div>
              `;
              
              desktopGrid.appendChild(modelCol);
            });
            
            desktopDiv.appendChild(desktopGrid);
            section.appendChild(desktopDiv);
            
            // Mobile layout
            const mobileDiv = document.createElement('div');
            mobileDiv.className = 'block lg:hidden space-y-6';
            
            config.models.forEach((model, modelIndex) => {
              const modelAudio = `data/${gender}/${model}/monitor_${language.code}_${sentence}.wav`;
              const modelCard = document.createElement('div');
              
              const modelName = model.replace('_', ' ').toUpperCase();
              const mobileSlidersHtml = config.ratings.map(rating => {
                const inputName = `${rating.id}_${model}_s${sectionIndex}_mobile`;
                const valueId = `${inputName}_value`;
                return `
                  <div class="flex flex-wrap  items-center space-x-3">
                    <label class="w-64 text-pink-700">${rating.label}</label>
                    <input type="range" min="0" max="10" value="5" step="1" name="${inputName}" 
                           class="flex-1 accent-pink-500" oninput="updateValue(this, '${valueId}')">
                    <span id="${valueId}" class="flex justify-center w-12 text-pink-700">5</span>
                  </div>
                `;
              }).join('');
              
              modelCard.innerHTML = `
              <div class="${modelIndex % 2 === 0 ? 'bg-pink-50' : ''} p-4 rounded-lg border border-pink-200">
                <div class="flex justify-center mb-4" style="align-items: center;">
                  <h4 style="margin-right: 15px">${modelIndex + 1}.</h4>
                  <audio preload="none" controls class="w-64 audio_style">
                    <source src="${modelAudio}" type="audio/wav">
                  </audio>
                </div>
                <div class="space-y-4">
                  ${mobileSlidersHtml}
                </div>
              </div>
              `;
              
              mobileDiv.appendChild(modelCard);
            });
            
            section.appendChild(mobileDiv);
            container.appendChild(section);
          });
        });
      });

      document.querySelectorAll('input[type="range"]').forEach(input => {
        const saved = localStorage.getItem(input.name);
        if (saved !== null) {
          input.value = saved;
          const spanId = input.name + "_value";
          const span = document.getElementById(spanId);
          if (span) span.textContent = saved;
        }
      });
          
      // Hide loader
      overlay.style.display = "none"
    }

  document.addEventListener("input", (e) => {
    if (e.target.type === "range") {
      localStorage.setItem(e.target.name, e.target.value);
    }
  });

    function submitSurvey() {
      // Collect all form data
      const formData = {};
      const inputs = document.querySelectorAll('input[type="range"]');
      
      inputs.forEach(input => {
        formData[input.name] = parseInt(input.value);
      });

      // Group ratings by section/model
      const groupedData = {};
      Object.keys(formData).forEach(key => {
        // if (key.includes('_mobile')) return; // skip mobile duplicates
        
        const parts = key.split('_');
        const rating = parts[0];   // e.g., "dissimilarity"
        const model = parts[1];    // e.g., "ModelA"
        const sectionKey = parts[2]; // e.g., "s1"
        
        if (!groupedData[sectionKey]) groupedData[sectionKey] = {};
        if (!groupedData[sectionKey][model]) groupedData[sectionKey][model] = {};
        
        groupedData[sectionKey][model][rating] = formData[key];
      });

      // Generate section metadata
      const sectionMetadata = {};
      let sectionIndex = 0;
      config.genders.forEach(gender => {
        config.languages.forEach(language => {
          config.sentences.forEach(sentence => {
            sectionIndex++;
            const sectionKey = `s${sectionIndex}`;
            const genderName = gender === "m" ? "Male" : "Female";
            sectionMetadata[sectionKey] = {
              section: sectionKey,
              gender: genderName,
              language: language.code,
              sentence: sentence
            };
          });
        });
      });

      // Flatten into list of row objects
      const rows = [];
      Object.keys(groupedData).forEach(sectionKey => {
        const sectionData = groupedData[sectionKey];
        const metadata = sectionMetadata[sectionKey];

        config.models.forEach(model => {
          if (sectionData[model]) {
            rows.push({
              section: metadata.section,
              gender: metadata.gender,
              language: metadata.language,
              model: model,
              dissimilarity: sectionData[model].dissimilarity,
              naturalness: sectionData[model].naturalness,
              pronunciation: sectionData[model].pronunciation,
              audioQuality: sectionData[model].audioQuality
            });
          }
        });
      });

      console.log("Survey rows:", rows);

      // Send all rows in one request
      sendToGoogleSheets(rows);
    }

    async function sendToGoogleSheets(sheetsData) {
      const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxdN7mOkBdJ_U24sDcVhBZzrtblCoQfKJkNoW9ukpykbBQRNhrCeS60yWtURyBVLGvE/exec";

      try {
        const overlay = document.getElementById("loaderOverlay");
        const waitingText = document.getElementById("waiting");
        const finishedText = document.getElementById("finished");
        const spinner = document.getElementById("spinner");
        const surveyLoading = document.getElementById("surveyLoading");

        // Show overlay before upload
        overlay.style.display = "flex";
        waitingText.style.display = "block";
        finishedText.style.display = "none";
        surveyLoading.style.display = "none";

        // One single POST request with the array
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors", // Apps Script requires this for public web app
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(sheetsData),
        });

        waitingText.style.display = "none";
        spinner.style.display = "none";
        finishedText.style.display = "block";
      } catch (err) {
        alert("❌ Error submitting survey: " + err);
      }
    }

    // Generate the survey when page loads
    document.addEventListener('DOMContentLoaded', generateSurvey);